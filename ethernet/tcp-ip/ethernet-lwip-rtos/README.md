## [tR]
STM32 mikrodenetleyicisinde TCP server oluşturabilmek için STM32CubeMX ile lwIP aktive edildi. Cihaza bir ip ataması yapmak istenildiğinden dolayı lwIP genel ayarlarından “LWIP_DHCP (DHCP Module)” devre dışı bırakılarak kullanıcı tarafından bir ip ataması gerçekleştirildi. Devre dışı bırakılan modülün altında üç farklı seçenek çıkmaktadır bunlar: ip adresi, alt ağ maskesi adresi ve ağ geçidi adresidir. Burada verilecek olan ip adresini kullanıcı belirlemektedir. İstemci olarak kullanılan cihazla aynı domainde bir ip adresi belirlemek gerekmektedir. Bunu yapabilmek içinde komut istemine “ipconfig” komutunu yazılarak ethernet bağlantısının IPv4 adresini öğrenildi ve bu ip adresine göre cihaza bir ip adresi verildi. Ethernet kablo bağlantısı için gerekli pinler ayarlanarak STM32 ile bilgisayar bağlantısı başarılı bir şekilde oluşturuldu. Oluşturulan bu bağlantıyı test etmek amacıyla yapılan ping atma işlemi komut istemi açılarak aşağıda belirtilen komut girildi.  

  ping ip addresi
  
Bu komut çalıştırılmadan önce Wi-Fi bağlantısı kapatılarak doğru bir şekilde ip adresinin karışmadan çalışması sağlandı. Yukarıda belirtilen komut çalıştığı takdirde STM32 mikrodenetleyicisinin başarılı bir şekilde sunucu haline geldiği anlaşılmaktadır. Pingleme işleminden sonra sunucuya bir yazı metni gönderildiği takdirde istemcide bunu görebilmek için Hercules programı kullanıldı. Hercules arayüzünden TCP Client sekmesi seçilerek belirtilen ip adresi ve kod içinde ayarlanan port numaraları girilerek mikrodenetleyici ile bağlantı kuruldu. Başarılı olarak kurulan bağlantı sayesinde sunucu üzerinden başarılı bir şekilde bilgi iletilerek istemci tarafına alımı gerçekleşti.

FreeRTOS aktif edilmeden oluşturulan TCP/IP sunucusu ara ara çökme yaşayabiliyordu ya da hiç açılmıyordu bunun sonucunda sıfırlama işlemi gerekebiliyordu. Bunun önüne geçebilmek amacıyla FreeRTOS aktif edilerek bu işlemleri bir thread içinde yapılması amaçlandı. STM32CubeMX kullanılarak FreeRTOS aktif edilirken CMSISv2 sürümü seçildi. “defaulTask” isminde bir görev oluşturularak önceliği “osPriorityNormal” olarak ayarlandı. Geri kalan her şey değiştirilemeyecek şekilde bu seçenekler kaydedildi.
“defaultTask” isimli thread içinde “tcpserver_init()” fonksiyonu çağrılarak sunucu tanımlaması gerçekleştirildi. Bu fonksiyon içerisinde lwIP nin netconn apisi kullanılarak TCP tanımlaması daha kolay bir şekilde gerçekleştirildi. “tcpserver_init()” fonksiyonu içerisinde “tcp thread” isimli bir thread açıldı. Bu threadin içerisinde sırasıyla TCP tanımlayıcısı oluşturulur. Kullanıcının girmiş olduğu ip adresine port numarası eklenir. Ardından sunucuyu dinleme moduna getirerek bağlı olan istemciden veri dinlemesi gerçekleştirilir. Herhangi bir istemci sunucuya bağlanmak istediği zaman “netconn_accept” bu bağlantı isteğini kabul eder. Bağlantı kabul edilirken bağlantı parametrelerini korumak amacıyla “newconn” isimli yeni bir netconn tanımlayıcısı kullanılır. Bu noktada istemci sunucuya bağlanmış durumdadır. Sunucu sadece istemciden gelen isteklere cevap verebilmektedir. Bu yüzden istemciden veri gelmesi için beklemektedir. “netconn_recv” isimli fonksiyon istemcinin sunucuya veri göndermesi için beklemektedir. Verinin ulaştığı vakit ip adresi ile port numarası ayrılmaktadır. Eğer ki bu bilgiye ihtiyaç duyulursa hazır olarak durması amacıyla bu işlem yapılmaktadır.  Daha sonrasında “netconn_write” isimli fonksiyon veriyi istemciye aktarmak için kullanılmaktadır. Bu fonksiyon cihaza ne bağlı ise ona veri göndermek için kullanılmaktadır. Veri gönderdikten sonra “msg array” temizlenerek yeni bir veri girişi elde edilmesi sağlanır. 

Başarılı olarak sunucu kurulumu gerçekleştirilen STM32 mikrodenetleyicisinin seri portundan bir bilgi aktarımı olduğu zaman bunu terminalde görebilmek amacıyla UART aktive edilerek kodlarda düzenleme yapıldı.  UART üzerinden başka bir bilgisayarın ya da herhangi bir cihazın seri portundan da çıktı görebilmek amacıyla USB TTL dönüştürücü kullanıldı.
